<!DOCTYPE html>
<html lang="uk">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Marketplace Mini App</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: linear-gradient(135deg, #000000 0%, #1a1a1a 100%);
      color: #ffffff;
      min-height: 100vh;
      padding: 20px;
      overflow-x: hidden;
    }

    .container {
      max-width: 600px;
      margin: 0 auto;
      animation: fadeIn 0.6s ease-out;
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(20px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .header {
      text-align: center;
      margin-bottom: 30px;
      padding: 30px 20px;
      background: rgba(255, 255, 255, 0.05);
      border-radius: 20px;
      border: 1px solid rgba(255, 255, 255, 0.1);
      backdrop-filter: blur(10px);
    }

    .header h1 {
      font-size: 2.5em;
      font-weight: 700;
      margin-bottom: 10px;
      background: linear-gradient(135deg, #ffffff 0%, #a0a0a0 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }

    .nav-tabs {
      display: flex;
      gap: 10px;
      margin-bottom: 20px;
      background: rgba(255, 255, 255, 0.05);
      padding: 8px;
      border-radius: 12px;
      border: 1px solid rgba(255, 255, 255, 0.1);
    }

    .nav-tab {
      flex: 1;
      padding: 12px;
      background: transparent;
      color: #999;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.3s ease;
      font-weight: 500;
    }

    .nav-tab.active {
      background: rgba(255, 255, 255, 0.1);
      color: #fff;
    }

    .tab-content {
      display: none;
    }

    .tab-content.active {
      display: block;
      animation: fadeIn 0.4s ease-out;
    }

    .card {
      background: rgba(255, 255, 255, 0.05);
      border-radius: 16px;
      padding: 20px;
      margin-bottom: 16px;
      border: 1px solid rgba(255, 255, 255, 0.1);
      transition: all 0.3s ease;
    }

    .card:hover {
      transform: translateY(-2px);
      border-color: rgba(255, 255, 255, 0.2);
      box-shadow: 0 8px 24px rgba(0, 0, 0, 0.4);
    }

    .product-card {
      display: grid;
      grid-template-columns: 100px 1fr;
      gap: 16px;
      align-items: start;
    }

    .product-image {
      width: 100px;
      height: 100px;
      background: rgba(255, 255, 255, 0.1);
      border-radius: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 3em;
      overflow: hidden;
    }

    .product-image img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    .product-info h3 {
      font-size: 1.2em;
      margin-bottom: 8px;
      color: #fff;
    }

    .product-price {
      font-size: 1.3em;
      font-weight: 700;
      color: #4caf50;
      margin: 8px 0;
    }

    .product-seller {
      font-size: 0.85em;
      color: #999;
      margin-bottom: 12px;
    }

    .product-actions {
      display: flex;
      gap: 8px;
      margin-top: 12px;
    }

    button {
      padding: 12px 20px;
      background: rgba(255, 255, 255, 0.1);
      color: #ffffff;
      border: 1px solid rgba(255, 255, 255, 0.2);
      border-radius: 10px;
      font-size: 0.95em;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    button:hover {
      background: rgba(255, 255, 255, 0.2);
      transform: translateY(-1px);
    }

    button.primary {
      background: linear-gradient(135deg, #4caf50 0%, #45a049 100%);
      color: #fff;
      border: none;
    }

    button.primary:hover {
      background: linear-gradient(135deg, #45a049 0%, #3d8b40 100%);
      box-shadow: 0 4px 12px rgba(76, 175, 80, 0.4);
    }

    button.secondary {
      background: linear-gradient(135deg, #2196f3 0%, #1976d2 100%);
      color: #fff;
      border: none;
    }

    button.danger {
      background: rgba(244, 67, 54, 0.2);
      color: #f44336;
      border-color: rgba(244, 67, 54, 0.4);
    }

    .form-group {
      margin-bottom: 16px;
    }

    .form-group label {
      display: block;
      margin-bottom: 8px;
      color: #ccc;
      font-size: 0.9em;
    }

    .form-group input, .form-group textarea {
      width: 100%;
      padding: 12px;
      background: rgba(255, 255, 255, 0.05);
      border: 1px solid rgba(255, 255, 255, 0.1);
      border-radius: 8px;
      color: #fff;
      font-size: 1em;
      font-family: inherit;
    }

    .form-group textarea {
      resize: vertical;
      min-height: 80px;
    }

    .form-group input:focus, .form-group textarea:focus {
      outline: none;
      border-color: rgba(255, 255, 255, 0.3);
      background: rgba(255, 255, 255, 0.08);
    }

    .form-group input[type="file"] {
      padding: 8px;
      cursor: pointer;
    }

    .form-group input[type="file"]::file-selector-button {
      padding: 8px 16px;
      background: rgba(255, 255, 255, 0.1);
      color: #fff;
      border: 1px solid rgba(255, 255, 255, 0.2);
      border-radius: 6px;
      cursor: pointer;
      margin-right: 12px;
      transition: all 0.3s ease;
    }

    .form-group input[type="file"]::file-selector-button:hover {
      background: rgba(255, 255, 255, 0.2);
    }

    #imagePreview {
      margin-top: 12px;
      text-align: center;
    }

    #previewImg {
      max-width: 100%;
      border-radius: 12px;
      max-height: 200px;
      border: 1px solid rgba(255, 255, 255, 0.1);
    }

    .cart-badge {
      position: relative;
      display: inline-block;
    }

    .cart-count {
      position: absolute;
      top: -8px;
      right: -8px;
      background: #f44336;
      color: #fff;
      border-radius: 10px;
      padding: 2px 6px;
      font-size: 0.75em;
      font-weight: 700;
    }

    .empty-state {
      text-align: center;
      padding: 60px 20px;
      color: #666;
    }

    .empty-state-icon {
      font-size: 4em;
      margin-bottom: 16px;
    }

    .cart-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 16px 0;
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    }

    .cart-item:last-child {
      border-bottom: none;
    }

    .cart-total {
      display: flex;
      justify-content: space-between;
      padding: 20px;
      background: rgba(76, 175, 80, 0.1);
      border-radius: 12px;
      margin-top: 16px;
      font-size: 1.2em;
      font-weight: 700;
    }

    .loading {
      text-align: center;
      padding: 40px;
      color: #666;
    }

    @media (max-width: 480px) {
      .header h1 { font-size: 2em; }
      .product-card { grid-template-columns: 80px 1fr; gap: 12px; }
      .product-image { width: 80px; height: 80px; font-size: 2.5em; }
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>üõí –ú–∞—Ä–∫–µ—Ç–ø–ª–µ–π—Å</h1>
    </div>

    <div class="nav-tabs">
      <button class="nav-tab active" onclick="switchTab('products')">üè™ –¢–æ–≤–∞—Ä–∏</button>
      <button class="nav-tab" onclick="switchTab('add')">‚ûï –î–æ–¥–∞—Ç–∏</button>
      <button class="nav-tab" onclick="switchTab('cart')">
        <span class="cart-badge">
          üõí –ö–æ—à–∏–∫
          <span class="cart-count" id="cartCount" style="display: none;">0</span>
        </span>
      </button>
      <button class="nav-tab" onclick="switchTab('my')">üë§ –ú–æ—ó</button>
    </div>

    <!-- Products Tab -->
    <div id="products-tab" class="tab-content active">
      <div id="productsList" class="loading">–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è —Ç–æ–≤–∞—Ä—ñ–≤...</div>
    </div>

    <!-- Add Product Tab -->
    <div id="add-tab" class="tab-content">
      <div class="card">
        <h2 style="margin-bottom: 20px;">üì¶ –î–æ–¥–∞—Ç–∏ –Ω–æ–≤–∏–π —Ç–æ–≤–∞—Ä</h2>
        <form id="addProductForm">
          <div class="form-group">
            <label>–ù–∞–∑–≤–∞ —Ç–æ–≤–∞—Ä—É *</label>
            <input type="text" id="productName" required placeholder="–ù–∞–ø—Ä–∏–∫–ª–∞–¥: iPhone 14 Pro">
          </div>
          <div class="form-group">
            <label>–û–ø–∏—Å</label>
            <textarea id="productDescription" placeholder="–û–ø–∏—à—ñ—Ç—å –≤–∞—à —Ç–æ–≤–∞—Ä..."></textarea>
          </div>
          <div class="form-group">
            <label>–¶—ñ–Ω–∞ (‚Ç¥) *</label>
            <input type="number" id="productPrice" required placeholder="0" min="0" step="0.01">
          </div>
          <div class="form-group">
            <label>–§–æ—Ç–æ —Ç–æ–≤–∞—Ä—É</label>
            <input type="file" id="productImage" accept="image/*" onchange="previewImage(event)">
            <div id="imagePreview" style="display: none;">
              <img id="previewImg" alt="Preview">
              <button type="button" onclick="clearImage()" style="margin-top: 8px; width: 100%;" class="danger">
                üóëÔ∏è –í–∏–¥–∞–ª–∏—Ç–∏ —Ñ–æ—Ç–æ
              </button>
            </div>
          </div>
          <button type="submit" class="primary" style="width: 100%; padding: 16px;">
            ‚úÖ –û–ø—É–±–ª—ñ–∫—É–≤–∞—Ç–∏ —Ç–æ–≤–∞—Ä
          </button>
        </form>
      </div>
    </div>

    <!-- Cart Tab -->
    <div id="cart-tab" class="tab-content">
      <div class="card">
        <h2 style="margin-bottom: 20px;">üõí –í–∞—à –∫–æ—à–∏–∫</h2>
        <div id="cartItems"></div>
        <div id="cartTotal"></div>
        <button onclick="checkout()" class="primary" id="checkoutBtn" style="width: 100%; margin-top: 16px; display: none;">
          üí≥ –û—Ñ–æ—Ä–º–∏—Ç–∏ –∑–∞–º–æ–≤–ª–µ–Ω–Ω—è
        </button>
      </div>
    </div>

    <!-- My Products Tab -->
    <div id="my-tab" class="tab-content">
      <div id="myProductsList" class="loading">–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è...</div>
    </div>
  </div>

  <script>
    const tg = window.Telegram.WebApp;
    let currentUser = null;
    let cart = [];
    let currentImageData = null;

    tg.ready();
    tg.expand();

    // Get user info
    if (tg.initDataUnsafe.user) {
      currentUser = tg.initDataUnsafe.user;
    } else {
      currentUser = { id: 'guest_' + Date.now(), first_name: '–ì—ñ—Å—Ç—å' };
    }

    // Initialize
    loadProducts();
    loadCart();

    // Image preview functions
    function previewImage(event) {
      const file = event.target.files[0];
      if (file) {
        if (file.size > 5 * 1024 * 1024) {
          tg.showAlert('–§–∞–π–ª –∑–∞–Ω–∞–¥—Ç–æ –≤–µ–ª–∏–∫–∏–π! –ú–∞–∫—Å–∏–º–∞–ª—å–Ω–∏–π —Ä–æ–∑–º—ñ—Ä: 5MB');
          event.target.value = '';
          return;
        }

        const reader = new FileReader();
        reader.onload = function(e) {
          currentImageData = e.target.result;
          document.getElementById('previewImg').src = currentImageData;
          document.getElementById('imagePreview').style.display = 'block';
        };
        reader.readAsDataURL(file);
      }
    }

    function clearImage() {
      currentImageData = null;
      document.getElementById('productImage').value = '';
      document.getElementById('imagePreview').style.display = 'none';
    }

    // Tab switching
    function switchTab(tab) {
      document.querySelectorAll('.nav-tab').forEach(t => t.classList.remove('active'));
      document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
      
      event.target.closest('.nav-tab').classList.add('active');
      document.getElementById(tab + '-tab').classList.add('active');

      if (tab === 'products') loadProducts();
      if (tab === 'my') loadMyProducts();
      if (tab === 'cart') displayCart();
    }

    // Load all products
    async function loadProducts() {
      const container = document.getElementById('productsList');
      container.innerHTML = '<div class="loading">–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è —Ç–æ–≤–∞—Ä—ñ–≤...</div>';

      try {
        const result = await window.storage.list('product:', true);
        
        if (!result || !result.keys || result.keys.length === 0) {
          container.innerHTML = `
            <div class="empty-state">
              <div class="empty-state-icon">üõçÔ∏è</div>
              <h3>–ü–æ–∫–∏ —â–æ –Ω–µ–º–∞—î —Ç–æ–≤–∞—Ä—ñ–≤</h3>
              <p>–°—Ç–∞–Ω—å—Ç–µ –ø–µ—Ä—à–∏–º, —Ö—Ç–æ –¥–æ–¥–∞—Å—Ç—å —Ç–æ–≤–∞—Ä!</p>
            </div>
          `;
          return;
        }

        const products = [];
        for (const key of result.keys) {
          try {
            const productResult = await window.storage.get(key, true);
            if (productResult && productResult.value) {
              products.push(JSON.parse(productResult.value));
            }
          } catch (e) {
            console.error('Error loading product:', e);
          }
        }

        products.sort((a, b) => b.timestamp - a.timestamp);
        displayProducts(products, container);
      } catch (error) {
        container.innerHTML = `
          <div class="empty-state">
            <div class="empty-state-icon">üõçÔ∏è</div>
            <h3>–¢–æ–≤–∞—Ä–∏ –ø–æ–∫–∏ –Ω–µ –¥–æ–¥–∞–Ω—ñ</h3>
            <p>–î–æ–¥–∞–π—Ç–µ –ø–µ—Ä—à–∏–π —Ç–æ–≤–∞—Ä —É —Ä–æ–∑–¥—ñ–ª—ñ "–î–æ–¥–∞—Ç–∏"</p>
          </div>
        `;
      }
    }

    // Display products
    function displayProducts(products, container) {
      if (products.length === 0) {
        container.innerHTML = `
          <div class="empty-state">
            <div class="empty-state-icon">üõçÔ∏è</div>
            <h3>–¢–æ–≤–∞—Ä—ñ–≤ –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ</h3>
          </div>
        `;
        return;
      }

      container.innerHTML = products.map(product => `
        <div class="card">
          <div class="product-card">
            <div class="product-image">
              ${product.image ? `<img src="${product.image}" alt="${escapeHtml(product.name)}">` : (product.emoji || 'üì¶')}
            </div>
            <div class="product-info">
              <h3>${escapeHtml(product.name)}</h3>
              <div class="product-seller">üë§ ${escapeHtml(product.sellerName)}</div>
              <p style="color: #ccc; font-size: 0.9em; margin-bottom: 8px;">${escapeHtml(product.description || '')}</p>
              <div class="product-price">${product.price} ‚Ç¥</div>
              <div class="product-actions">
                <button class="primary" onclick='addToCart(${JSON.stringify(product).replace(/'/g, "&apos;")})'>
                  üõí –í –∫–æ—à–∏–∫
                </button>
                <button class="secondary" onclick='viewProduct(${JSON.stringify(product).replace(/'/g, "&apos;")})'>
                  üëÅÔ∏è –î–µ—Ç–∞–ª—å–Ω—ñ—à–µ
                </button>
              </div>
            </div>
          </div>
        </div>
      `).join('');
    }

    // Add product form
    document.getElementById('addProductForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      
      const name = document.getElementById('productName').value.trim();
      const description = document.getElementById('productDescription').value.trim();
      const price = parseFloat(document.getElementById('productPrice').value);

      if (!name || price <= 0) {
        tg.showAlert('–ë—É–¥—å –ª–∞—Å–∫–∞, –∑–∞–ø–æ–≤–Ω—ñ—Ç—å –≤—Å—ñ –æ–±–æ–≤\'—è–∑–∫–æ–≤—ñ –ø–æ–ª—è');
        return;
      }

      const product = {
        id: 'prod_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9),
        name,
        description,
        price,
        image: currentImageData,
        emoji: currentImageData ? null : 'üì¶',
        sellerId: currentUser.id,
        sellerName: currentUser.first_name,
        timestamp: Date.now()
      };

      try {
        await window.storage.set('product:' + product.id, JSON.stringify(product), true);
        
        tg.showPopup({
          title: '–£—Å–ø—ñ—Ö!',
          message: '–í–∞—à —Ç–æ–≤–∞—Ä —É—Å–ø—ñ—à–Ω–æ –¥–æ–¥–∞–Ω–æ –¥–æ –º–∞—Ä–∫–µ—Ç–ø–ª–µ–π—Å—É üéâ',
          buttons: [{type: 'ok'}]
        });

        document.getElementById('addProductForm').reset();
        clearImage();
        tg.HapticFeedback.notificationOccurred('success');
        
        switchTab('products');
        loadProducts();
      } catch (error) {
        tg.showAlert('–ü–æ–º–∏–ª–∫–∞ –ø—Ä–∏ –¥–æ–¥–∞–≤–∞–Ω–Ω—ñ —Ç–æ–≤–∞—Ä—É. –°–ø—Ä–æ–±—É–π—Ç–µ —â–µ —Ä–∞–∑.');
      }
    });

    // Load my products
    async function loadMyProducts() {
      const container = document.getElementById('myProductsList');
      container.innerHTML = '<div class="loading">–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –≤–∞—à–∏—Ö —Ç–æ–≤–∞—Ä—ñ–≤...</div>';

      try {
        const result = await window.storage.list('product:', true);
        
        if (!result || !result.keys || result.keys.length === 0) {
          container.innerHTML = `
            <div class="empty-state">
              <div class="empty-state-icon">üì¶</div>
              <h3>–£ –≤–∞—Å —â–µ –Ω–µ–º–∞—î —Ç–æ–≤–∞—Ä—ñ–≤</h3>
              <p>–ü–µ—Ä–µ–π–¥—ñ—Ç—å —É —Ä–æ–∑–¥—ñ–ª "–î–æ–¥–∞—Ç–∏" —â–æ–± –æ–ø—É–±–ª—ñ–∫—É–≤–∞—Ç–∏ —Ç–æ–≤–∞—Ä</p>
            </div>
          `;
          return;
        }

        const myProducts = [];
        for (const key of result.keys) {
          try {
            const productResult = await window.storage.get(key, true);
            if (productResult && productResult.value) {
              const product = JSON.parse(productResult.value);
              if (product.sellerId === currentUser.id) {
                myProducts.push(product);
              }
            }
          } catch (e) {
            console.error('Error loading product:', e);
          }
        }

        if (myProducts.length === 0) {
          container.innerHTML = `
            <div class="empty-state">
              <div class="empty-state-icon">üì¶</div>
              <h3>–£ –≤–∞—Å —â–µ –Ω–µ–º–∞—î —Ç–æ–≤–∞—Ä—ñ–≤</h3>
              <p>–ü–µ—Ä–µ–π–¥—ñ—Ç—å —É —Ä–æ–∑–¥—ñ–ª "–î–æ–¥–∞—Ç–∏" —â–æ–± –æ–ø—É–±–ª—ñ–∫—É–≤–∞—Ç–∏ —Ç–æ–≤–∞—Ä</p>
            </div>
          `;
          return;
        }

        myProducts.sort((a, b) => b.timestamp - a.timestamp);
        displayMyProducts(myProducts, container);
      } catch (error) {
        container.innerHTML = `
          <div class="empty-state">
            <div class="empty-state-icon">üì¶</div>
            <h3>–£ –≤–∞—Å —â–µ –Ω–µ–º–∞—î —Ç–æ–≤–∞—Ä—ñ–≤</h3>
          </div>
        `;
      }
    }

    // Display my products
    function displayMyProducts(products, container) {
      container.innerHTML = products.map(product => `
        <div class="card">
          <div class="product-card">
            <div class="product-image">
              ${product.image ? `<img src="${product.image}" alt="${escapeHtml(product.name)}">` : (product.emoji || 'üì¶')}
            </div>
            <div class="product-info">
              <h3>${escapeHtml(product.name)}</h3>
              <p style="color: #ccc; font-size: 0.9em; margin-bottom: 8px;">${escapeHtml(product.description || '')}</p>
              <div class="product-price">${product.price} ‚Ç¥</div>
              <div class="product-actions">
                <button class="danger" onclick='deleteProduct("${product.id}")'>
                  üóëÔ∏è –í–∏–¥–∞–ª–∏—Ç–∏
                </button>
              </div>
            </div>
          </div>
        </div>
      `).join('');
    }

    // Delete product
    async function deleteProduct(productId) {
      tg.showPopup({
        title: '–í–∏–¥–∞–ª–∏—Ç–∏ —Ç–æ–≤–∞—Ä?',
        message: '–¶—è –¥—ñ—è –Ω–µ–∑–≤–æ—Ä–æ—Ç–Ω–∞',
        buttons: [
          {id: 'delete', type: 'destructive', text: '–í–∏–¥–∞–ª–∏—Ç–∏'},
          {type: 'cancel'}
        ]
      }, async (buttonId) => {
        if (buttonId === 'delete') {
          try {
            await window.storage.delete('product:' + productId, true);
            tg.HapticFeedback.notificationOccurred('success');
            loadMyProducts();
          } catch (error) {
            tg.showAlert('–ü–æ–º–∏–ª–∫–∞ –ø—Ä–∏ –≤–∏–¥–∞–ª–µ–Ω–Ω—ñ —Ç–æ–≤–∞—Ä—É');
          }
        }
      });
    }

    // Cart functions
    function loadCart() {
      const saved = localStorage.getItem('cart_' + currentUser.id);
      if (saved) {
        cart = JSON.parse(saved);
        updateCartBadge();
      }
    }

    function saveCart() {
      localStorage.setItem('cart_' + currentUser.id, JSON.stringify(cart));
      updateCartBadge();
    }

    function addToCart(product) {
      const existing = cart.find(item => item.id === product.id);
      if (existing) {
        existing.quantity++;
      } else {
        cart.push({...product, quantity: 1});
      }
      saveCart();
      tg.HapticFeedback.notificationOccurred('success');
      tg.showAlert('–¢–æ–≤–∞—Ä –¥–æ–¥–∞–Ω–æ –¥–æ –∫–æ—à–∏–∫–∞! üõí');
    }

    function removeFromCart(productId) {
      cart = cart.filter(item => item.id !== productId);
      saveCart();
      displayCart();
    }

    function updateCartBadge() {
      const badge = document.getElementById('cartCount');
      const total = cart.reduce((sum, item) => sum + item.quantity, 0);
      if (total > 0) {
        badge.textContent = total;
        badge.style.display = 'block';
      } else {
        badge.style.display = 'none';
      }
    }

    function displayCart() {
      const container = document.getElementById('cartItems');
      const totalContainer = document.getElementById('cartTotal');
      const checkoutBtn = document.getElementById('checkoutBtn');

      if (cart.length === 0) {
        container.innerHTML = `
          <div class="empty-state">
            <div class="empty-state-icon">üõí</div>
            <h3>–ö–æ—à–∏–∫ –ø–æ—Ä–æ–∂–Ω—ñ–π</h3>
            <p>–î–æ–¥–∞–π—Ç–µ —Ç–æ–≤–∞—Ä–∏ –∑ –º–∞—Ä–∫–µ—Ç–ø–ª–µ–π—Å—É</p>
          </div>
        `;
        totalContainer.innerHTML = '';
        checkoutBtn.style.display = 'none';
        return;
      }

      container.innerHTML = cart.map(item => `
        <div class="cart-item">
          <div>
            <strong>${escapeHtml(item.name)}</strong>
            <div style="color: #999; font-size: 0.9em;">
              ${item.quantity} √ó ${item.price} ‚Ç¥ = ${(item.quantity * item.price).toFixed(2)} ‚Ç¥
            </div>
          </div>
          <button class="danger" onclick='removeFromCart("${item.id}")' style="padding: 8px 16px;">
            üóëÔ∏è
          </button>
        </div>
      `).join('');

      const total = cart.reduce((sum, item) => sum + (item.quantity * item.price), 0);
      totalContainer.innerHTML = `
        <div class="cart-total">
          <span>–í—Å—å–æ–≥–æ:</span>
          <span>${total.toFixed(2)} ‚Ç¥</span>
        </div>
      `;
      checkoutBtn.style.display = 'block';
    }

    function checkout() {
      const total = cart.reduce((sum, item) => sum + (item.quantity * item.price), 0);
      tg.showPopup({
        title: '–û—Ñ–æ—Ä–º–ª–µ–Ω–Ω—è –∑–∞–º–æ–≤–ª–µ–Ω–Ω—è',
        message: `–ó–∞–≥–∞–ª—å–Ω–∞ —Å—É–º–∞: ${total.toFixed(2)} ‚Ç¥\n\n–ü—Ä–æ–¥–æ–≤–∂–∏—Ç–∏ –æ—Ñ–æ—Ä–º–ª–µ–Ω–Ω—è?`,
        buttons: [
          {id: 'confirm', type: 'default', text: '–¢–∞–∫, –æ—Ñ–æ—Ä–º–∏—Ç–∏'},
          {type: 'cancel'}
        ]
      }, (buttonId) => {
        if (buttonId === 'confirm') {
          cart = [];
          saveCart();
          displayCart();
          tg.showAlert('–ó–∞–º–æ–≤–ª–µ–Ω–Ω—è —É—Å–ø—ñ—à–Ω–æ –æ—Ñ–æ—Ä–º–ª–µ–Ω–æ! üéâ\n\n–ó –≤–∞–º–∏ –∑–≤\'—è–∂–µ—Ç—å—Å—è –ø—Ä–æ–¥–∞–≤–µ—Ü—å.');
          tg.HapticFeedback.notificationOccurred('success');
        }
      });
    }

    function viewProduct(product) {
      tg.showPopup({
        title: product.name,
        message: `${product.description || '–ë–µ–∑ –æ–ø–∏—Å—É'}\n\n–¶—ñ–Ω–∞: ${product.price} ‚Ç¥\n–ü—Ä–æ–¥–∞–≤–µ—Ü—å: ${product.sellerName}`,
        buttons: [{type: 'close'}]
      });
    }

    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    tg.BackButton.show();
    tg.BackButton.onClick(() => tg.close());
  </script>
</body>
</html>
